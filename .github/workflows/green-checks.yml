name: Green Checks

on:
  pull_request:
  push:
    branches: [ master ]

jobs:
  green-checks:
    runs-on: ubuntu-latest

    steps:

      - name: Cache Yarn Classic
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/yarn
            frontend/node_modules
          key: yarn-classic-${{ hashFiles('frontend/yarn.lock') }}
          restore-keys: |
            yarn-classic-

      - name: Cache Yarn Berry
        uses: actions/cache@v5
        with:
          path: |
            frontend/.yarn/cache
            frontend/.pnp.cjs
          key: yarn-berry-${{ hashFiles('frontend/yarn.lock') }}
          restore-keys: |
            yarn-berry-

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -----------------------------
      # ECOCODE
      # -----------------------------
      - name: Switch to frontend directory
        run: |
         cd frontend
         yarn install --frozen-lockfile --immutable --immutable-cache
        env: 
          PLUGIN_ID: activemq-classic 
          PLUGIN_SCOPE: activemqClassic 
          PLUGIN_MODULE: plugin

      - name: Execute creedengo scan
        run: |
         cd frontend
         npx eslint . -f json -o ../reports/creedengo.json
         cd ..
        env: 
          PLUGIN_ID: activemq-classic 
          PLUGIN_SCOPE: activemqClassic 
          PLUGIN_MODULE: plugin

      # -----------------------------
      # OVERALL SCORE
      # -----------------------------
      - name: Compute overall score
        run: node .github/scripts/compute-overall.js

      # -----------------------------
      # BADGES
      # -----------------------------
      - name: Generate badges
        run: node .github/scripts/generate-badge.js

      # -----------------------------
      # COMMENTO PR
      # -----------------------------
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## ðŸŒ± Green Checks Report
            **Creedengo:** $(cat reports/creedengo.json | jq -r '.score')
            **Overall:** $(cat reports/overall.json | jq -r '.score')

      # -----------------------------
      # RELEASE
      # -----------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: green-checks
          path: |
            reports/
            badges/
