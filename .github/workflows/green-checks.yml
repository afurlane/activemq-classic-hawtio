name: Green Checks

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  green:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 1. Build plugin (backend + frontend)
      - name: Build plugin (Maven)
        run: ./mvnw -B clean install

      # 2. SCI via Impact Framework
      - name: Install Impact Framework
        run: npm install @grnsft/if @grnsft/if-plugins @grnsft/if-unofficial-plugins

      - name: Run SCI (Impact Framework)
        run: node .github/scripts/run-sci.js

      # 3. ECOCode
      - name: Install ECOCode CLI
        run: npm install -g @ecocode/cli

      - name: Run ECOCode
        run: ecocode scan --config .ecocode.json

      # 4. GreenFrame
      - name: Install GreenFrame CLI
        run: npm install -g @greenframe/cli

      - name: Start static server
        run: |
          npx http-server frontend/build -p 8080 &
          sleep 3

      - name: Run GreenFrame
        run: greenframe run --config greenframe.config.js

      # 5. Upload reports
      - name: Upload reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: green-reports
          path: |
            sci-report.json
            ecocode-report.json
            greenframe-report.json

      # 6. Generate badge JSON
      - name: Generate badge JSON files
        run: node .github/scripts/extract-badges.js

      # 7. Publish badge JSON to gh-pages
      - name: Publish badge JSON to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: badges
          publish_branch: gh-pages
          keep_files: true

      # 8. Comment PR
      - name: Comment PR with summary
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### ðŸŒ± Green Report Summary
            **SCI COâ‚‚:** see artifact  
            **EcoCode Issues:** see artifact  
            **GreenFrame COâ‚‚:** see artifact  
            Badge JSON updated on `gh-pages`.
