name: Green Checks

on:
  pull_request:
  push:
    branches: [ master ]

jobs:
  green-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -----------------------------
      # ECOCODE
      # -----------------------------
      - name: Install ECOCode CLI
        run: npm install -g @ecocode/cli

      - name: Run ECOCode (backend)
        run: ecocode scan --path backend --output reports/ecocode-backend.json

      - name: Run ECOCode (frontend)
        run: ecocode scan --path frontend --output reports/ecocode-frontend.json

      - name: Merge ECOCode reports
        run: node .github/scripts/extract-ecocode.js

      # -----------------------------
      # GREENFRAME
      # -----------------------------
      - name: Install GreenFrame
        run: npm install -g @greenframe/cli

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Serve frontend
        run: |
          npx http-server frontend/dist -p 8080 &
          sleep 5

      - name: Run GreenFrame
        run: greenframe run --config greenframe.config.js --output reports/greenframe.json

      # -----------------------------
      # OVERALL SCORE
      # -----------------------------
      - name: Compute overall score
        run: node .github/scripts/compute-overall.js

      # -----------------------------
      # BADGES
      # -----------------------------
      - name: Generate badges
        run: node .github/scripts/generate-badge.js

      # -----------------------------
      # COMMENTO PR
      # -----------------------------
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ## ðŸŒ± Green Checks Report
            **ECOCode:** $(cat reports/ecocode.json | jq -r '.score')
            **GreenFrame:** $(cat reports/greenframe.json | jq -r '.score')
            **Overall:** $(cat reports/overall.json | jq -r '.score')

      # -----------------------------
      # RELEASE
      # -----------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: green-checks
          path: |
            reports/
            badges/
